{% extends "base.html" %}

{% block title %}ü§ñ AgriBot ‚Äì Votre assistant agricole{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="text-center mb-4">
    <h2 class="text-success"><i class="fas fa-robot"></i> AgriBot ‚Äì Votre assistant agricole</h2>
    <p class="lead mt-3" style="max-width: 700px; margin: auto;">
      Bonjour et bienvenue !<br>
      Je suis <strong>AgriBot</strong>, ton assistant agricole intelligent ü§ñüåæ<br>
      Pose-moi tes questions sur l‚Äôagriculture, la m√©t√©o, les sols ou la vie rurale,<br>
      et je te r√©pondrai avec clart√© !
    </p>
    <img src="{{ url_for('static', filename='images/agribot-avatar.png') }}" alt="AgriBot Avatar"
         width="100" class="mb-3 rounded-circle shadow">
  </div>

  <!-- Zone de discussion -->
  <div class="card mb-4" style="min-height: 300px;">
    <div class="card-body" id="chat-container" style="max-height: 400px; overflow-y: auto;">
      <!-- Messages dynamiques ici -->
    </div>
  </div>

  <!-- Formulaire de saisie -->
  <form id="chat-form" class="d-flex">
    <input type="text" id="user-input" name="question" class="form-control me-2" placeholder="Pose ta question ici‚Ä¶" required>
    <button type="submit" class="btn btn-success">Envoyer</button>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  const chatContainer = document.getElementById('chat-container');
  const chatForm = document.getElementById('chat-form');
  const input = document.getElementById('user-input');

  function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function appendMessage(role, message) {
    const isUser = role === 'user';
    const avatar = isUser
      ? 'https://cdn-icons-png.flaticon.com/512/1946/1946429.png'
      : 'https://cdn-icons-png.flaticon.com/512/4712/4712109.png';

    const div = document.createElement('div');
    div.className = `d-flex mb-3 ${isUser ? 'justify-content-end' : 'justify-content-start'}`;
    div.innerHTML = `
      <div class="d-flex ${isUser ? 'flex-row-reverse' : ''} align-items-start" style="max-width: 80%;">
        <img src="${avatar}" class="rounded-circle me-2" alt="avatar" width="40" height="40">
        <div class="${isUser ? 'bg-success text-white' : 'bg-light border'} p-2 rounded" style="max-width: 100%;">
          <small class="d-block fw-bold">${isUser ? 'Vous' : 'AgriBot'}</small>
          <span>${message}</span>
        </div>
      </div>
    `;
    chatContainer.appendChild(div);
    scrollToBottom();
  }

  chatForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    const question = input.value.trim();
    if (!question) return;

    appendMessage("user", question);
    input.value = "";

    // Affiche un loader
    const loader = document.createElement("div");
    loader.className = "text-muted fst-italic ms-2";
    loader.textContent = "AgriBot r√©fl√©chit...";
    chatContainer.appendChild(loader);
    scrollToBottom();

    try {
      const res = await fetch("{{ url_for('main.agribot') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question })
      });
      const data = await res.json();
      chatContainer.removeChild(loader);

      if (data.error) {
        appendMessage("bot", "‚ö†Ô∏è " + data.error);
      } else {
        appendMessage("bot", data.response);
      }
    } catch (err) {
      chatContainer.removeChild(loader);
      appendMessage("bot", "‚ùå Erreur de connexion. R√©essaie.");
    }
  });
</script>
{% endblock %}
