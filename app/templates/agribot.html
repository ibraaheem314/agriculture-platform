{% extends "base.html" %}

{% block title %}ðŸ¤– AgriBot â€“ Votre assistant agricole{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="text-center text-success mb-4"><i class="fas fa-robot"></i> AgriBot â€“ Votre assistant agricole</h2>

    <!-- Zone de discussion -->
    <div class="card mb-4" style="min-height: 300px;">
        <div class="card-body" id="chat-box" style="max-height: 400px; overflow-y: auto;">
            <!-- Messages affichÃ©s ici -->
        </div>
    </div>

    <!-- Formulaire de saisie -->
    <form id="chatbot-form" class="d-flex">
        <input type="text" id="question" name="question" class="form-control me-2" placeholder="Posez une questionâ€¦" required>
        <button type="submit" class="btn btn-success">Envoyer</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  const chatBox = document.getElementById("chat-box");
  const form = document.getElementById("chatbot-form");
  const input = document.getElementById("question");

  function appendMessage(sender, text, type = "user") {
      const msg = document.createElement("div");
      msg.className = "mb-2";
      msg.innerHTML = `<strong class="${type === 'user' ? 'text-success' : (type === 'error' ? 'text-danger' : 'text-primary')}">${sender} :</strong> ${text}`;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
  }

  form.addEventListener("submit", function (e) {
      e.preventDefault();
      const question = input.value.trim();
      if (!question) return;

      appendMessage("Vous", question, "user");
      input.value = "";

      fetch("{{ url_for('main.agribot') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question })
      })
          .then(res => res.json())
          .then(data => {
              if (data.error) {
                  const errorMessage = typeof data.error === "object" ? JSON.stringify(data.error) : data.error;
                  appendMessage("AgriBot", `Erreur : ${errorMessage}`, "error");
              } else {
                  appendMessage("AgriBot", data.response, "bot");
              }
          })
          .catch(err => {
              appendMessage("AgriBot", "Erreur de connexion.", "error");
          });
  });
</script>

{% endblock %}
